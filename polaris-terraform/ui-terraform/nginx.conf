load_module modules/ngx_http_js_module.so;
user  nginx;
worker_processes  auto;

error_log  /dev/stderr warn;
pid        /var/run/nginx.pid;

events {}

http {
  js_import templates/nginx.js;
	access_log  /dev/stdout;

  # Notes on proxy_pass:
  # 1) If the string passed to the proxy_pass directive DOES NOT have a slash in it: 
  #     location /foo/ {
  #         proxy_pass http://other-host; # WITHOUT A TRAILING SLASH
  #      }
  #     then http://host/foo/bar will direct to http://other-host/foo/bar (note /foo/ in path)

  #    If the string passed to the proxy_pass directive DOES have a slash in it: 
  #     location /foo/ {
  #         proxy_pass http://other-host/; # WITH A TRAILING SLASH
  #      }
  #     then http://host/foo/bar will direct to http://other-host/bar (note no /foo/ in path)
  # 2) By default proxy_pass will redirect incoming `location /foo` to incoming `location /foo/`
  server {
    resolver ${RESOLVER} valid=30s;
    listen 80;
    server_name ${WEBSITE_HOSTNAME};

    location / {
      add_header Content-Type text/plain;
      return 200 'Polaris Proxy is online';
    }

    # CMS UI traffic
    location /CMS.20.0.04 {
      if ($http_user_agent !~* Trident) {
        return 403 'Need to enable IE Compability mode';
      }

      add_header X-UA-Compatible IE=5;

      sub_filter_once off;
      sub_filter ${UPSTREAM_CMS_IP} ${WEBSITE_HOSTNAME};
      sub_filter ${UPSTREAM_CMS_DOMAIN_NAME} ${WEBSITE_HOSTNAME};
      proxy_redirect     off;
      proxy_ssl_server_name on;
      proxy_set_header Host ${UPSTREAM_CMS_DOMAIN_NAME}:443;
      proxy_set_header X-Forwarded-For $remote_addr;

      proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${UPSTREAM_CMS_IP};
    }

    # At development time it is useful to have a path through to CMS Modern
    location /modern/ {
      proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${UPSTREAM_CMS_MODERN_IP}/;
    }
    
    # CMS UI -> Polaris cookie handover step 1 (CMS-side redirects to Polaris-side putting cookies in querystring)
    location /polaris {
      js_var $redirectHostAddress ${ENDPOINT_HTTP_PROTOCOL}://${WEBSITE_HOSTNAME};
      js_content nginx.polarisAuthRedirect;
    }

    # CMS UI -> Polaris cookie handover step 2 (Polaris-side receives redirect with cookies in querystring)
    location /api/init {
      proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${AUTH_HANDOVER_ENDPOINT_DOMAIN_NAME};
    }

    # Polaris UI
    location /${APP_SUBFOLDER_PATH} {
      sub_filter_once off;
      # The REACT_APP_GATEWAY_BASE_URL setting of the UI app should be set to the raw gateway URL.  It is up to
      #  the proxy to translate this to the correct URL for the environment.  This is because we can be running
      #  with unknown domain names when in QA or production, so here is the correct place to do the switch. In
      #  particular, at the time of writing QA is accessed equally as https://polaris-qa-cmsproxy.azurewebsites.net
      #  and https://polaris-qa-notprod.cpsdev.co.uk
      sub_filter ${API_ENDPOINT_DOMAIN_NAME} ${WEBSITE_HOSTNAME};
      # The REACT_APP_REAUTH_REDIRECT_URL setting of the UI app should be set to the raw DDIE URL, for the same reason
      #  as above.
      sub_filter ${DDEI_ENDPOINT_DOMAIN_NAME}/api/ ${WEBSITE_HOSTNAME};
      # By default nginx will only filter/transpose in html documents, so specify rules explictly
      sub_filter_types text/html text/javascript text/js text/css text/plain application/json application/javascript;
      proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${APP_ENDPOINT_DOMAIN_NAME};
    }

    # Polaris gateway API traffic
    location /api/ {
      sub_filter_once off;
      # We need to translate gateway-specific URLs found in API responses
      #  to proxy URLs (important in pipeline tracker polling flow where pipeline initiation call returns a polling address)
      sub_filter ${API_ENDPOINT_DOMAIN_NAME} ${WEBSITE_HOSTNAME};
      # By default nginx will only filter/transpose in html documents, so specify rules explictly.
      #  Note: it is not just json that comes through the /api/ route, but also html e.g. for the dev login endpoints
      #  so specifiy the full range of document types that we want to filter
      sub_filter_types text/html text/javascript text/js text/css text/plain application/json application/javascript;
      proxy_redirect off;
      proxy_ssl_server_name on;
      proxy_set_header Host ${API_ENDPOINT_DOMAIN_NAME}:443;
      proxy_set_header X-Forwarded-For $remote_addr;

      proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${API_ENDPOINT_DOMAIN_NAME};
    }

    # Development-time alternative CMS login page (allows non IETab mode users to achieve CMS session log in)
    location /dev-login/ {
        proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${DDEI_ENDPOINT_DOMAIN_NAME}/api/login?code=${DDEI_ENDPOINT_FUNCTION_APP_KEY};
    }

    # Development-time alternative CMS login page (allows non IETab mode users to achieve CMS session log in)
    location /api/dev-login-full-cookie/ {
        proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${DDEI_ENDPOINT_DOMAIN_NAME}/api/login-full-cookie?code=${DDEI_ENDPOINT_FUNCTION_APP_KEY};
    }

    # internal-only route to CMS Classic, used by DDEI
    location /internal-implementation/CMS.20.0.04/ {
      sub_filter_once off;
      sub_filter ${UPSTREAM_CMS_IP} ${WEBSITE_HOSTNAME};
      sub_filter ${UPSTREAM_CMS_DOMAIN_NAME} ${WEBSITE_HOSTNAME};
      proxy_redirect     off;
      proxy_ssl_server_name on;
      proxy_set_header Host ${UPSTREAM_CMS_DOMAIN_NAME}:443;
      proxy_set_header X-Forwarded-For $remote_addr;

      proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${UPSTREAM_CMS_IP}/CMS.20.0.04/;
    }

    # internal-only route to CMS Modern, used by DDEI
    location /internal-implementation/modern/ {
      proxy_pass ${ENDPOINT_HTTP_PROTOCOL}://${UPSTREAM_CMS_MODERN_IP}/;
    }
  }
}