---
parameters:
  - name: stageBuildAgent
    type: string
  - name: targetBuild
    type: string
  - name: targetLabel
    type: string
  - name: targetName
    type: string
  - name: buildDefinitionId
    type: string
  - name: appInsightsKey
    type: string
  - name: devOpsPatToken
    type: string
  - name: targetTestEnv
    type: string

stages:
  - stage: Run_e2e_Tests_${{ parameters.targetLabel }}
    displayName: e2e tests > ${{ parameters.targetLabel }}
    dependsOn: Check_${{ parameters.targetLabel }}
    condition: succeeded()
    pool:
      name: ${{ parameters.stageBuildAgent }}
    jobs:
      - template: jobs/job_log-start.yml
        parameters:
          targetBuild: ${{ parameters.targetBuild }}
          targetLabel: ${{ parameters.targetLabel }}
          targetName: ${{ parameters.targetName }}
          appInsightsKey: ${{ parameters.appInsightsKey }}

      - template: jobs/job_generate-slot-name.yml
        parameters:
          targetBuild: ${{ parameters.targetBuild }}
          jobDependsOn:
            - LogStart
              
      - template: jobs/job_run-e2e-tests.yml
        parameters:
          targetLabel: ${{ parameters.targetLabel }}
          buildDefinitionId: ${{ parameters.buildDefinitionId }}
          targetTestEnv: ${{ parameters.targetTestEnv }}
          devOpsPatToken: ${{ parameters.devOpsPatToken }}
          jobDependsOn:
            - GenerateSlotName
            
      - template: jobs/job_log-result.yml
        parameters:
          targetBuild: ${{ parameters.targetBuild }}
          targetLabel: ${{ parameters.targetLabel }}
          targetName: ${{ parameters.targetName }}
          appInsightsKey: ${{ parameters.appInsightsKey }}
          devOpsPatToken: ${{ parameters.devOpsPatToken }}
          jobDependsOn:
            - LogStart
            - RunE2ETests
