---
parameters:
  - name: targetBuild
    type: string
  - name: targetTerraformArtifact
    type: string
  - name: targetLabel
    type: string
  - name: targetName
    type: string
  - name: targetSuffix
    type: string
  - name: appInsightsKey
    type: string
  - name: azureSubscription
    type: string
    
steps:
  # download pipeline terraform build artifact, which also contains the logic app definitions
  - download: ${{ parameters.targetBuild }}
    displayName: Terraform > Download Terraform build
    artifact: ${{ parameters.targetTerraformArtifact }}
    
  # send custom event to AppInsights
  - template: task_send-to-app-insights.yml
    parameters:
      appInsightsKey: ${{ parameters.appInsightsKey }}
      targetBuild: ${{ parameters.targetBuild }}
      message: "${{ parameters.targetLabel }} ${{ parameters.targetName }}: Publish Alert Processor - Started"
    
  # prepare a zip
  - task: ArchiveFiles@2
    displayName: Zip Logic App Definition
    inputs:
      rootFolderOrFile: '$(Pipeline.Workspace)/${{ parameters.targetBuild }}/${{ parameters.targetTerraformArtifact }}/logic-app-definitions'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Pipeline.Workspace)/$(Build.BuildId)_alert_processor.zip'
      replaceExistingArchive: true
      
  - task: AzureFunctionApp@1
    displayName: Create/Update Alert Processor
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      appType: functionAppLinux
      appName: "SendCaAlertToTc${{ parameters.targetSuffix }}"
      package: "$(Pipeline.Workspace)/$(Build.BuildId)_alert_processor.zip"
      deploymentMethod: "zipDeploy"
      
  # send custom event to AppInsights
  - template: task_send-to-app-insights.yml
    parameters:
      appInsightsKey: ${{ parameters.appInsightsKey }}
      targetBuild: ${{ parameters.targetBuild }}
      message: "${{ parameters.targetLabel }} ${{ parameters.targetName }}: Publish Alert Processor - Completed"