---
trigger: none
pr: none

resources:
  pipelines:
    - pipeline: PolarisNetworkingBuild
      source: Polaris Networking - Build
      trigger:
        branches:
          include:
            - refs/heads/main
        stages:
          - Publish_Artifacts
            
variables:
  - group: kv-dev-terraform
  - group: polaris-global
  - group: polaris-status-check-endpoints
  - group: terraform-containers

stages:
  - stage: Apply_DEV
    displayName: DEV > Apply Terraform
    pool:
      name: $(dev-build-agent)
    jobs:
      - deployment: Log_Start_Terraform
        displayName: DEV > Log Terraform Start
        environment: "Dev"
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_log-start-deployment.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetLabel: "DEV"
                    targetName: "Networking Terraform CI Deployment"
                    appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"

      - deployment: Apply_Networking_Terraform
        displayName: Dev > Apply Terraform
        dependsOn: Log_Start_Terraform
        condition: succeeded()
        environment: "Dev"
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_apply-terraform.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetTerraformArtifact: "networking-terraform-files"
                    targetLabel: "DEV"
                    targetName: "Networking Terraform CI Deployment"
                    targetPlanName: "dev"
                    appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"
                    terraformStorageAccount: $(dev-terraform-storage-account)
                    terraformContainerName: $(networking-terraform-container-name)
                    terraformStateKey: $(terraform-key)
                    terraformStateAccessKey: $(cpsdevstorageterraform-key1)
                    armClientId: $(innovation-development-spn-client-id)
                    armClientSecret: $(innovation-development-spn-secret)
                    armTenantId: $(innovation-development-spn-tenant-id)
                    armSubscriptionId: $(innovation-development-subscription-id)
                    
      - deployment: Log_Result_Terraform_Ended
        displayName: Log Terraform End
        dependsOn: Apply_Networking_Terraform
        condition: succeeded()
        environment: "Dev"
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_log-result-deployment.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetLabel: "DEV"
                    targetName: "Networking Terraform CI Deployment"
                    appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"
                    devOpsPatToken: "$(System.AccessToken)"
                    
  # DEV: CHECK CURRENT STATUS RESPONSES FROM /API/STATUS ENDPOINTS FOLLOWING TERRAFORM CHANGES
  - stage: Check_DEV
    displayName: DEV > Build Checks
    dependsOn: Apply_DEV
    condition: succeeded()
    pool:
      name: $(dev-build-agent)
    jobs:
      - job: Log_Start
        displayName: Log Start
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetName: "Build Checks"
              appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"

      - job: Get_Status_URIs
        dependsOn: Log_Start
        condition: succeeded()
        displayName: Get Status URIs
        steps:
          - template: tasks/task_get-status-uris.yml
            parameters:
              targetSuffix: "-dev"
              armClientId: $(innovation-development-spn-client-id)
              armClientSecret: $(innovation-development-spn-secret)
              armTenantId: $(innovation-development-spn-tenant-id)
              armSubscriptionId: $(innovation-development-subscription-id)

      - job: Check_Coordinator
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.coordinatorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetAppName: "Coordinator"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "coordinator"

      - job: Check_PDF_Generator
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.pdfGeneratorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetAppName: "PDF Generator"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "pdf-generator"

      - job: Check_PDF_Redactor
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.pdfRedactorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetAppName: "PDF Redactor"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "pdf-redactor"

      - job: Check_Text_Extractor
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.textExtractorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetAppName: "Text Extractor"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "text-extractor"

      - job: Check_Gateway
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.gatewayUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetAppName: "Gateway"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "polaris-gateway"

      - job: Check_Proxy
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.proxyUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetAppName: "Proxy"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "Polaris Proxy is online"

      - job: Check_SPA
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.spaUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetAppName: "UI"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/polaris-ui/build-version.txt"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "ui"

      - job: Log_Result
        dependsOn:
          - Log_Start
          - Get_Status_URIs
          - Check_Coordinator
          - Check_PDF_Generator
          - Check_Text_Extractor
          - Check_Gateway
          - Check_Proxy
          - Check_SPA
        condition: succeeded()
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetName: "Build Checks"
              appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"
  
  # DEV: SAVE COMMIT REPORTS TO THE PIPELINE REPO          
  - stage: Create_Commit_Report_DEV
    displayName: DEV > Save Report
    dependsOn: Check_Dev
    condition: succeeded()
    jobs:
      - job: Log_Start
        displayName: Log Start
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetName: "Create Commit Report"
              appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"

      - job: Create_Commit_Report
        dependsOn: Log_Start
        condition: succeeded()
        steps:
          - template: tasks/task_create-commit-report.yml
            parameters:
              targetLabel: "DEV"
              targetLabelLower: "dev"

      - job: Log_Result
        condition: succeeded()
        dependsOn:
          - Log_Start
          - Create_Commit_Report
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetName: "Create Commit Report"
              appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"
  
  # DEV: MOVE THE GITHUB TAG TO THE TIP OF MAIN          
  - stage: Update_GitHub_Tag_DEV
    displayName: DEV > Update Tag
    dependsOn: Create_Commit_Report_DEV
    condition: succeeded()
    jobs:
      - job: Log_Start
        displayName: Log Start
        condition: succeeded()
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetName: "Update GitHub Tag"
              appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"

      - job: Update_Github_Tag
        dependsOn: Log_Start
        condition: succeeded()
        steps:
          - template: tasks/task_update-github-tag.yml
            parameters:
              targetLabel: "DEV"

      - job: Log_Result
        condition: succeeded()
        dependsOn:
          - Log_Start
          - Update_GitHub_Tag
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "DEV"
              targetName: "Update GitHub Tag"
              appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"
              
  #DEV: RUN E2E TESTS AS FINAL CHECKS          
  - stage: Run_e2e_Tests_DEV
    displayName: e2e tests
    dependsOn: Update_GitHub_Tag
    condition: succeeded()
    variables:
      runTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_TERRAFORM']]
      runCodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_CODEBASE']]
    jobs:
      - job: Log_Start
        displayName: Log Start
        condition: and(succeeded(), or(eq(variables.runTerraform, 'true'),eq(variables.runCodebase, 'true')))
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisBuild
              targetLabel: "DEV"
              targetName: "e2e Tests"
              appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"

      - job: Run_e2e_Tests
        condition: and(succeeded(), or(eq(variables.runTerraform, 'true'),eq(variables.runCodebase, 'true')))
        dependsOn: Log_Start
        steps:
          - template: tasks/task_run-e2e-tests.yml
            parameters:
              targetLabel: "DEV"
              buildDefinitionId: 129
              devOpsPatToken: "$(System.AccessToken)"

      - job: Log_Result
        condition: and(succeeded(), or(eq(variables.runTerraform, 'true'),eq(variables.runCodebase, 'true')))
        dependsOn:
          - Log_Start
          - Run_e2e_Tests
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisBuild
              targetLabel: "DEV"
              targetName: "e2e Tests"
              appInsightsKey: "$(innovation-development-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"

  # QA Apply to QA
  - stage: Apply_QA
    displayName: QA > Apply Terraform
    dependsOn: Update_GitHub_Tag_DEV
    pool:
      name: $(qa-build-agent)
    jobs:
      - deployment: Log_Start_Terraform
        displayName: QA > Log Terraform Start
        environment: "QA"
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_log-start-deployment.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetLabel: "QA"
                    targetName: "Networking Terraform CI Deployment"
                    appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"

      - deployment: Apply_Networking_Terraform
        displayName: QA > Apply Terraform
        dependsOn: Log_Start_Terraform
        condition: succeeded()
        environment: "QA"
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_apply-terraform.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetTerraformArtifact: "networking-terraform-files"
                    targetLabel: "QA"
                    targetName: "Networking Terraform CI Deployment"
                    targetPlanName: "qa"
                    appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"
                    terraformStorageAccount: $(qa-terraform-storage-account)
                    terraformContainerName: $(networking-terraform-container-name)
                    terraformStateKey: $(terraform-key)
                    terraformStateAccessKey: $(cpsqastorageterraform-key1)
                    armClientId: $(innovation-qa-spn-client-id)
                    armClientSecret: $(innovation-qa-spn-secret)
                    armTenantId: $(innovation-qa-spn-tenant-id)
                    armSubscriptionId: $(innovation-qa-subscription-id)

      - deployment: Log_Result_Terraform_Ended
        displayName: Log Terraform End
        dependsOn: Apply_Networking_Terraform
        condition: succeeded()
        environment: "QA"
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_log-result-deployment.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetLabel: "QA"
                    targetName: "Networking Terraform CI Deployment"
                    appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"
                    devOpsPatToken: "$(System.AccessToken)"

  # QA: CHECK CURRENT STATUS RESPONSES FROM /API/STATUS ENDPOINTS FOLLOWING TERRAFORM CHANGES
  - stage: Check_QA
    displayName: QA > Build Checks
    dependsOn: Apply_QA
    condition: succeeded()
    pool:
      name: $(qa-build-agent)
    jobs:
      - job: Log_Start
        displayName: Log Start
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetName: "Build Checks"
              appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"

      - job: Get_Status_URIs
        dependsOn: Log_Start
        condition: succeeded()
        displayName: Get Status URIs
        steps:
          - template: tasks/task_get-status-uris.yml
            parameters:
              targetSuffix: "-qa"
              armClientId: $(innovation-qa-spn-client-id)
              armClientSecret: $(innovation-qa-spn-secret)
              armTenantId: $(innovation-qa-spn-tenant-id)
              armSubscriptionId: $(innovation-qa-subscription-id)

      - job: Check_Coordinator
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.coordinatorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetAppName: "Coordinator"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "coordinator"

      - job: Check_PDF_Generator
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.pdfGeneratorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetAppName: "PDF Generator"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "pdf-generator"

      - job: Check_PDF_Redactor
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.pdfRedactorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetAppName: "PDF Redactor"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "pdf-redactor"

      - job: Check_Text_Extractor
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.textExtractorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetAppName: "Text Extractor"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "text-extractor"

      - job: Check_Gateway
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.gatewayUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetAppName: "Gateway"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "polaris-gateway"

      - job: Check_Proxy
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.proxyUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetAppName: "Proxy"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "Polaris Proxy is online"

      - job: Check_SPA
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.spaUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetAppName: "UI"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/polaris-ui/build-version.txt"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "ui"

      - job: Log_Result
        dependsOn:
          - Log_Start
          - Get_Status_URIs
          - Check_Coordinator
          - Check_PDF_Generator
          - Check_Text_Extractor
          - Check_Gateway
          - Check_Proxy
          - Check_SPA
        condition: succeeded()
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetName: "Build Checks"
              appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"

  # QA: SAVE COMMIT REPORTS TO THE PIPELINE REPO          
  - stage: Create_Commit_Report_DEV
    displayName: QA > Save Report
    dependsOn: Check_QA
    condition: succeeded()
    jobs:
      - job: Log_Start
        displayName: Log Start
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetName: "Create Commit Report"
              appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"

      - job: Create_Commit_Report
        dependsOn: Log_Start
        condition: succeeded()
        steps:
          - template: tasks/task_create-commit-report.yml
            parameters:
              targetLabel: "QA"
              targetLabelLower: "qa"

      - job: Log_Result
        condition: succeeded()
        dependsOn:
          - Log_Start
          - Create_Commit_Report
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetName: "Create Commit Report"
              appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"

  # QA: MOVE THE GITHUB TAG TO THE TIP OF MAIN          
  - stage: Update_GitHub_Tag_QA
    displayName: QA > Update Tag
    dependsOn: Create_Commit_Report_QA
    condition: succeeded()
    jobs:
      - job: Log_Start
        displayName: Log Start
        condition: succeeded()
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetName: "Update GitHub Tag"
              appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"

      - job: Update_Github_Tag
        dependsOn: Log_Start
        condition: succeeded()
        steps:
          - template: tasks/task_update-github-tag.yml
            parameters:
              targetLabel: "QA"

      - job: Log_Result
        condition: succeeded()
        dependsOn:
          - Log_Start
          - Update_GitHub_Tag
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "QA"
              targetName: "Update GitHub Tag"
              appInsightsKey: "$(innovation-qa-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"

  # Apply to PROD              
  - stage: Apply_PROD
    displayName: PROD > Apply Terraform
    dependsOn: Update_GitHub_Tag_DEV
    condition: succeeded()
    pool:
      name: $(prod-build-agent)
    jobs:
      - deployment: Log_Start_Terraform
        displayName: PROD > Log Terraform Start
        environment: "Prod"
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_log-start-deployment.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetLabel: "PROD"
                    targetName: "Networking Terraform CI Deployment"
                    appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"

      - deployment: Apply_Networking_Terraform
        displayName: PROD > Apply Terraform
        dependsOn: Log_Start_Terraform
        condition: succeeded()
        environment: "Prod"
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_apply-terraform.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetTerraformArtifact: "networking-terraform-files"
                    targetLabel: "PROD"
                    targetName: "Networking Terraform CI Deployment"
                    targetPlanName: "prod"
                    appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"
                    terraformStorageAccount: $(prod-terraform-storage-account)
                    terraformContainerName: $(networking-terraform-container-name)
                    terraformStateKey: $(terraform-key)
                    terraformStateAccessKey: $(cpsprodstorageterraform-key1)
                    armClientId: $(innovation-prod-spn-client-id)
                    armClientSecret: $(innovation-prod-spn-secret)
                    armTenantId: $(innovation-prod-spn-tenant-id)
                    armSubscriptionId: $(innovation-prod-subscription-id)

      - deployment: Log_Result_Terraform_Ended
        displayName: Log Terraform End
        dependsOn: Apply_Networking_Terraform
        condition: succeeded()
        environment: "Prod"
        strategy:
          runOnce:
            deploy:
              steps:
                - template: tasks/task_log-result-deployment.yml
                  parameters:
                    targetBuild: PolarisNetworkingBuild
                    targetLabel: "PROD"
                    targetName: "Networking Terraform CI Deployment"
                    appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"
                    devOpsPatToken: "$(System.AccessToken)"

  # DEV: CHECK CURRENT STATUS RESPONSES FROM /API/STATUS ENDPOINTS FOLLOWING TERRAFORM CHANGES
  - stage: Check_PROD
    displayName: PROD > Build Checks
    dependsOn: Apply_PROD
    condition: succeeded()
    pool:
      name: $(prod-build-agent)
    jobs:
      - job: Log_Start
        displayName: Log Start
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetName: "Build Checks"
              appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"

      - job: Get_Status_URIs
        dependsOn: Log_Start
        condition: succeeded()
        displayName: Get Status URIs
        steps:
          - template: tasks/task_get-status-uris.yml
            parameters:
              targetSuffix: ""
              armClientId: $(innovation-prod-spn-client-id)
              armClientSecret: $(innovation-prod-spn-secret)
              armTenantId: $(innovation-prod-spn-tenant-id)
              armSubscriptionId: $(innovation-prod-subscription-id)

      - job: Check_Coordinator
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.coordinatorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetAppName: "Coordinator"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "coordinator"

      - job: Check_PDF_Generator
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.pdfGeneratorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetAppName: "PDF Generator"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "pdf-generator"

      - job: Check_PDF_Redactor
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.pdfRedactorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetAppName: "PDF Redactor"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "pdf-redactor"

      - job: Check_Text_Extractor
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.textExtractorUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetAppName: "Text Extractor"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "text-extractor"

      - job: Check_Gateway
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.gatewayUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetAppName: "Gateway"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/api/status"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "polaris-gateway"

      - job: Check_Proxy
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.proxyUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetAppName: "Proxy"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "Polaris Proxy is online"

      - job: Check_SPA
        dependsOn: Get_Status_URIs
        condition: succeeded()
        variables:
          uri: $[dependencies.Get_Status_URIs.outputs['uris.spaUri']]
        steps:
          - template: tasks/task_call-status-endpoint.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetAppName: "UI"
              targetScript: "InvokeRequestWithRetryNonNumeric.ps1"
              endpointUri: "$(uri)/polaris-ui/build-version.txt"
              statusCheckMethod: $(status-check-method)
              statusCheckRetries: $(status-check-retries)
              statusCheckDelaySeconds: $(status-check-delay-seconds)
              statusCheckTimeoutSeconds: $(status-check-timeout-seconds)
              successTextContent: "ui"

      - job: Log_Result
        dependsOn:
          - Log_Start
          - Get_Status_URIs
          - Check_Coordinator
          - Check_PDF_Generator
          - Check_Text_Extractor
          - Check_Gateway
          - Check_Proxy
          - Check_SPA
        condition: succeeded()
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetName: "Build Checks"
              appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"

  # DEV: SAVE COMMIT REPORTS TO THE PIPELINE REPO          
  - stage: Create_Commit_Report_PROD
    displayName: PROD > Save Report
    dependsOn: Check_PROD
    condition: succeeded()
    jobs:
      - job: Log_Start
        displayName: Log Start
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetName: "Create Commit Report"
              appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"

      - job: Create_Commit_Report
        dependsOn: Log_Start
        condition: succeeded()
        steps:
          - template: tasks/task_create-commit-report.yml
            parameters:
              targetLabel: "PROD"
              targetLabelLower: "prod"

      - job: Log_Result
        condition: succeeded()
        dependsOn:
          - Log_Start
          - Create_Commit_Report
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetName: "Create Commit Report"
              appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"

  # DEV: MOVE THE GITHUB TAG TO THE TIP OF MAIN          
  - stage: Update_GitHub_Tag_PROD
    displayName: PROD > Update Tag
    dependsOn: Create_Commit_Report_PROD
    condition: succeeded()
    jobs:
      - job: Log_Start
        displayName: Log Start
        condition: succeeded()
        steps:
          - template: tasks/task_log-start.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetName: "Update GitHub Tag"
              appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"

      - job: Update_Github_Tag
        dependsOn: Log_Start
        condition: succeeded()
        steps:
          - template: tasks/task_update-github-tag.yml
            parameters:
              targetLabel: "PROD"

      - job: Log_Result
        condition: succeeded()
        dependsOn:
          - Log_Start
          - Update_GitHub_Tag
        steps:
          - template: tasks/task_log-result.yml
            parameters:
              targetBuild: PolarisNetworkingBuild
              targetLabel: "PROD"
              targetName: "Update GitHub Tag"
              appInsightsKey: "$(innovation-prod-app-insights-instrumentation-key)"
              devOpsPatToken: "$(System.AccessToken)"
