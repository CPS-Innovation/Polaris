parameters:
  devClientId: ""
  devClientSecret: ""
  tenantId: ""
  devSubscriptionId: ""
  devResourceGroup: ""
  qaClientId: ""
  qaClientSecret: ""
  qaSubscriptionId: ""
  qaResourceGroup: ""
  prodClientId: ""
  prodClientSecret: ""
  prodSubscriptionId: ""
  prodResourceGroup: ""
  versionSha: ""
  devAgentPoolName: "polarisdevagentspool"
  qaAgentPoolName: "polarisqaagentspool"
  prodAgentPoolName: "polarisprodagentspool"


steps:
  - bash: |
      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
      az account set --subscription $ARM_SUBSCRIPTION_ID
      
      $imageCreateResult = $(az sig image-version create --resource-group $ARM_RESOURCE_GROUP --gallery-name polaris_build_agent_gallery --gallery-image-definition polaris_build_agent --gallery-image-version 1.0.$(Build.BuildId) --managed-image /subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$ARM_RESOURCE_GROUP/providers/Microsoft.Compute/images/build-agent-$ARM_VERSION_SHA)
      $imageCreateResultObject = $imageCreateResult | ConvertFrom-Json
      $imageId = $imageCreateResultObject.id
      
      Write-Host "##vso[task.setvariable variable=ImageId;]$imageId"
    displayName: Create new image version in the gallery
    condition: succeeded()
    env:
      ARM_CLIENT_ID: ${{ parameters.devClientId }}
      ARM_CLIENT_SECRET: ${{ parameters.devClientSecret }}
      ARM_TENANT_ID: ${{ parameters.tenantId }}
      ARM_SUBSCRIPTION_ID: ${{ parameters.devSubscriptionId }}
      ARM_RESOURCE_GROUP: ${{ parameters.devResourceGroup }}
      ARM_VERSION_SHA: ${{ parameters.versionSha }}
      
  - bash: |
      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
      az account set --subscription $ARM_SUBSCRIPTION_ID
      az vmss update --resource-group $ARM_RESOURCE_GROUP --name $ARM_POOL_NAME --set virtualMachineProfile.storageProfile.imageReference.id=$(ImageId)
      az vmss update-instances --instance-ids "*" --name $ARM_POOL_NAME --resource-group $ARM_RESOURCE_GROUP --no-wait
    displayName: DEV - Update Scale Set
    condition: succeeded()
    env:
      ARM_CLIENT_ID: ${{ parameters.devClientId }}
      ARM_CLIENT_SECRET: ${{ parameters.devClientSecret }}
      ARM_TENANT_ID: ${{ parameters.tenantId }}
      ARM_SUBSCRIPTION_ID: ${{ parameters.devSubscriptionId }}
      ARM_RESOURCE_GROUP: ${{ parameters.devResourceGroup }}
      ARM_POOL_NAME: ${{ parameters.devAgentPoolName }}
      
  - bash: |
      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
      az account set --subscription $ARM_SUBSCRIPTION_ID
      az vmss update --resource-group $ARM_RESOURCE_GROUP --name $ARM_POOL_NAME --set virtualMachineProfile.storageProfile.imageReference.id=$(ImageId)
      az vmss update-instances --instance-ids "*" --name $ARM_POOL_NAME --resource-group $ARM_RESOURCE_GROUP --no-wait
    displayName: QA - Update Scale Set
    condition: succeeded()
    env:
      ARM_CLIENT_ID: ${{ parameters.qaClientId }}
      ARM_CLIENT_SECRET: ${{ parameters.qaClientSecret }}
      ARM_TENANT_ID: ${{ parameters.tenantId }}
      ARM_SUBSCRIPTION_ID: ${{ parameters.qaSubscriptionId }}
      ARM_RESOURCE_GROUP: ${{ parameters.qaResourceGroup }}
      ARM_POOL_NAME: ${{ parameters.qaAgentPoolName }}
      
  - bash: |
      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
      az account set --subscription $ARM_SUBSCRIPTION_ID
      az vmss update --resource-group $ARM_RESOURCE_GROUP --name $ARM_POOL_NAME --set virtualMachineProfile.storageProfile.imageReference.id=$(ImageId)
      az vmss update-instances --instance-ids "*" --name $ARM_POOL_NAME --resource-group $ARM_RESOURCE_GROUP --no-wait
    displayName: PROD - Update Scale Set
    condition: succeeded()
    env:
      ARM_CLIENT_ID: ${{ parameters.prodClientId }}
      ARM_CLIENT_SECRET: ${{ parameters.prodClientSecret }}
      ARM_TENANT_ID: ${{ parameters.tenantId }}
      ARM_SUBSCRIPTION_ID: ${{ parameters.prodSubscriptionId }}
      ARM_RESOURCE_GROUP: ${{ parameters.prodResourceGroup }}
      ARM_POOL_NAME: ${{ parameters.prodAgentPoolName }}