parameters:
  devClientId: ""
  devClientSecret: ""
  tenantId: ""
  devSubscriptionId: ""
  devResourceGroup: ""
  qaSubscriptionId: ""
  qaResourceGroup: ""
  prodSubscriptionId: ""
  prodResourceGroup: ""
  versionSha: ""
  
steps:
  - bash: |
      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
      az account set --subscription $ARM_SUBSCRIPTION_ID
      az image copy --source-resource-group $ARM_RESOURCE_GROUP --source-object-name build-agent-$ARM_VERSION_SHA --source-type image --target-location uksouth --target-resource-group $ARM_QA_RESOURCE_GROUP --target-subscription $ARM_QA_SUBSCRIPTION_ID
    displayName: QA - Copy Image
    env:
      ARM_CLIENT_ID: ${{ parameters.devClientId }}
      ARM_CLIENT_SECRET: ${{ parameters.devClientSecret }}
      ARM_TENANT_ID: ${{ parameters.tenantId }}
      ARM_SUBSCRIPTION_ID: ${{ parameters.devSubscriptionId }}
      ARM_RESOURCE_GROUP: ${{ parameters.devResourceGroup }}
      ARM_VERSION_SHA: ${{ parameters.versionSha }}
      ARM_QA_RESOURCE_GROUP: ${{ parameters.qaResourceGroup }}
      ARM_QA_SUBSCRIPTION_ID: ${{ parameters.qaSubscriptionId }}
      
  - bash: |
      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
      az account set --subscription $ARM_SUBSCRIPTION_ID
      az image copy --source-resource-group $ARM_RESOURCE_GROUP --source-object-name build-agent-$ARM_VERSION_SHA --source-type image --target-location uksouth --target-resource-group $ARM_PROD_RESOURCE_GROUP --target-subscription $ARM_PROD_SUBSCRIPTION_ID
    displayName: PROD - Copy Image
    env:
      ARM_CLIENT_ID: ${{ parameters.devClientId }}
      ARM_CLIENT_SECRET: ${{ parameters.devClientSecret }}
      ARM_TENANT_ID: ${{ parameters.tenantId }}
      ARM_SUBSCRIPTION_ID: ${{ parameters.devSubscriptionId }}
      ARM_RESOURCE_GROUP: ${{ parameters.devResourceGroup }}
      ARM_VERSION_SHA: ${{ parameters.versionSha }}
      ARM_QA_RESOURCE_GROUP: ${{ parameters.prodResourceGroup }}
      ARM_QA_SUBSCRIPTION_ID: ${{ parameters.prodSubscriptionId }}