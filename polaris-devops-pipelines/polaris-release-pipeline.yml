# Unified Build and Release Azure DevOps pipeline for Polaris Terraform and Codebase

trigger: none
pr: none

resources:
  pipelines:
    - pipeline: PolarisBuild
      source: Polaris - Build
      trigger:
        branches:
          include:
            - refs/heads/main
        stages:
          - Publish_Artifacts

variables:
  - group: kv-dev-terraform
  - group: kv-qa-terraform
  - group: kv-prod-terraform
  - group: polaris-global
  - group: pipeline-terraform
  - group: ui-terraform
  - group: polaris-status-check-endpoints
  - group: polaris-vpn

stages:
  - stage: Determine_Changes
    displayName: Determine Changes
    jobs:
      - job: Generate_Diff
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                $files = $(git diff --name-only --relative --diff-filter AMRD dev HEAD)
                $temp=$files -split ' '
                $count=$temp.Length
                echo "******** Total changed $count files for DEV ********"

                For ($i=0; $i -lt $temp.Length; $i++)
                {
                  $name=$temp[$i]
                  echo "this is $name file"
                  if ($name -like 'polaris-terraform/pipeline-terraform/*')
                  {
                    echo "run pipeline terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TERRAFORM_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_EVENTS_TERRAFORM_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_TERRAFORM_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-terraform/pipeline-events-terraform/*')
                  {
                    echo "DEV: run pipeline events terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_EVENTS_TERRAFORM_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-terraform/ui-terraform/*')
                  {
                    echo "DEV: run ui terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_TERRAFORM_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_DEV;isOutput=true]true"                    
                  }
                  if ($name -like 'polaris-terraform/ui-events-terraform/*')
                  {
                    echo "DEV: run ui events terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/*')
                  {
                    echo "DEV: run pipeline codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/coordinator/*')
                  {
                    echo "DEV: run coordinator..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/pdf-generator/*')
                  {
                    echo "DEV: run pdf generator..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/text-extractor/*')
                  {
                    echo "DEV: run text extractor..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/*')
                  {
                    echo "DEV: run gateway codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-gateway/*')
                  {
                    echo "DEV: run gateway..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-auth-handover/*')
                  {
                    echo "DEV: run auth handover..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-ui/*')
                  {
                    echo "DEV: run ui codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/DdeiClient/*')
                  {
                    echo "DEV: changes to DdeiClient detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/Common/*')
                  {
                    echo "DEV: changes to the Pipeline's Common library detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-gateway.common/*')
                  {
                    echo "DEV: changes to the Gateway's Common library detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_DEV;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_DEV;isOutput=true]true"
                  }
                  if ($name -like 'polaris-e2e/*')
                  {
                    echo "DEV: changes to the e2e tests detected make sure they are run..."
                    Write-Host "##vso[task.setvariable variable=RUN_E2E_TESTS_DEV;isOutput=true]true"
                  }
                }

                $files = $(git diff --name-only --relative --diff-filter AMRD qa HEAD)
                $temp=$files -split ' '
                $count=$temp.Length
                echo "******** Total changed $count files for QA ********"

                For ($i=0; $i -lt $temp.Length; $i++)
                {
                  $name=$temp[$i]
                  echo "this is $name file"
                  if ($name -like 'polaris-terraform/pipeline-terraform/*')
                  {
                    echo "QA: run pipeline terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TERRAFORM_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_EVENTS_TERRAFORM_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_TERRAFORM_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-terraform/pipeline-events-terraform/*')
                  {
                    echo "QA: run pipeline events terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_EVENTS_TERRAFORM_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-terraform/ui-terraform/*')
                  {
                    echo "QA: run ui terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_TERRAFORM_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_QA;isOutput=true]true"                    
                  }
                  if ($name -like 'polaris-terraform/ui-events-terraform/*')
                  {
                    echo "QA: run ui events terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/*')
                  {
                    echo "QA: run pipeline codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/coordinator/*')
                  {
                    echo "QA: run coordinator..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/pdf-generator/*')
                  {
                    echo "QA: run pdf generator..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/text-extractor/*')
                  {
                    echo "QA: run text extractor..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/*')
                  {
                    echo "QA: run gateway codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-gateway/*')
                  {
                    echo "QA: run gateway..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-auth-handover/*')
                  {
                    echo "QA: run auth handover..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-ui/*')
                  {
                    echo "QA: run ui codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/DdeiClient/*')
                  {
                    echo "QA: changes to DdeiClient detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/Common/*')
                  {
                    echo "QA: changes to the Pipeline's Common library detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-gateway.common/*')
                  {
                    echo "QA: changes to the Gateway's Common library detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_QA;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_QA;isOutput=true]true"
                  }
                  if ($name -like 'polaris-e2e/*')
                  {
                    echo "QA: changes to the e2e tests detected make sure they are run..."
                    Write-Host "##vso[task.setvariable variable=RUN_E2E_TESTS_QA;isOutput=true]true"
                  }
                }

                $files = $(git diff --name-only --relative --diff-filter AMRD prod HEAD)
                $temp=$files -split ' '
                $count=$temp.Length
                echo "******** Total changed $count files for PROD ********"

                For ($i=0; $i -lt $temp.Length; $i++)
                {
                  $name=$temp[$i]
                  echo "this is $name file"
                  if ($name -like 'polaris-terraform/pipeline-terraform/*')
                  {
                    echo "PROD: run pipeline terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TERRAFORM_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_EVENTS_TERRAFORM_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_TERRAFORM_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-terraform/pipeline-events-terraform/*')
                  {
                    echo "PROD: run pipeline events terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_EVENTS_TERRAFORM_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-terraform/ui-terraform/*')
                  {
                    echo "PROD: run ui terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_TERRAFORM_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_PROD;isOutput=true]true"                    
                  }
                  if ($name -like 'polaris-terraform/ui-events-terraform/*')
                  {
                    echo "PROD: run ui events terraform..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_EVENTS_TERRAFORM_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/*')
                  {
                    echo "PROD: run pipeline codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/coordinator/*')
                  {
                    echo "PROD: run coordinator..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/pdf-generator/*')
                  {
                    echo "PROD: run pdf generator..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/text-extractor/*')
                  {
                    echo "PROD: run text extractor..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/*')
                  {
                    echo "PROD: run gateway codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-gateway/*')
                  {
                    echo "PROD: run gateway..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-auth-handover/*')
                  {
                    echo "PROD: run auth handover..."
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-ui/*')
                  {
                    echo "PROD: run ui codebase..."
                    Write-Host "##vso[task.setvariable variable=RUN_UI_CODEBASE_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/DdeiClient/*')
                  {
                    echo "PROD: changes to DdeiClient detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-pipeline/Common/*')
                  {
                    echo "PROD: changes to the Pipeline's Common library detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_PDF_GENERATOR_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_TEXT_EXTRACTOR_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_CODEBASE_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-gateway/polaris-gateway.common/*')
                  {
                    echo "PROD: changes to the Gateway's Common library detected run dependent code-bases..."
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_CODEBASE_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_PIPELINE_COORDINATOR_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_AUTH_HANDOVER_PROD;isOutput=true]true"
                    Write-Host "##vso[task.setvariable variable=RUN_GATEWAY_GATEWAY_PROD;isOutput=true]true"
                  }
                  if ($name -like 'polaris-e2e/*')
                  {
                    echo "PROD: changes to the e2e tests detected make sure they are run..."
                    Write-Host "##vso[task.setvariable variable=RUN_E2E_TESTS_PROD;isOutput=true]true"
                  }
                }
            name: Change_Results
            displayName: Processing changes to repo

  - stage: Apply_DEV
    displayName: Deployment > DEV
    condition: succeeded()
    dependsOn: Determine_Changes
    variables:
      runPipelineTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TERRAFORM_DEV']]
      runPipelineEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_EVENTS_TERRAFORM_DEV']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_DEV']]
      runUIEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_EVENTS_TERRAFORM_DEV']]
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_DEV']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_DEV']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_DEV']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_DEV']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_DEV']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_DEV']]
    pool:
      vmImage: ubuntu-latest
    jobs:
      - deployment: CI_Deploy_Polaris
        environment: "Dev"
        strategy:
          runOnce:
            deploy:
              steps:
                #download templates artifact
                - download: PolarisBuild
                  displayName: Download Templates
                  artifact: 'polaris-template-files'
                  
                #download scripts artifact
                - download: PolarisBuild
                  displayName: Download Scripts
                  artifact: 'polaris-script-files'
                  
                #create vpn tunnel
                - bash: |
                    sudo apt-get --assume-yes --no-install-recommends install openvpn

                    chmod 777 vpnconfig.ovpn
                    envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

                    sudo openvpn _vpnconfig.ovpn &

                    sleep 5

                    ifconfig tun0

                    sudo rm /etc/resolv.conf
                    echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
                  env:
                    PRESHAREDKEY: $(dev_pre-shared_key)
                    PRIVATEKEY: $(dev_private_key)
                    CLIENTCERTIFICATE: $(dev_client_cert)
                    VPNSERVER: $(dev_vpn_server)
                    DNSSERVER: $(dev_dns_server)
                  displayName: Creating DEV VPN tunnel
                  
                # Install Terraform based on version variable
                - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
                  displayName: Terraform > Install
                  condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true')))
                  inputs:
                    terraformVersion: $(terraform-version)
                  
                #install nuget
                - bash: |
                    sudo yum install -y mono-complete
                    sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
                    sudo chmod +x /usr/local/bin/nuget
                    nuget install Microsoft.ApplicationInsights
                  displayName: Installing Application Insights
                  condition: succeeded()
                  
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: succeeded()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Started"
                  
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Pipeline Terraform - Started"
                      
                #download pipeline terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  displayName: Terraform > Download Pipeline terraform build
                  artifact: "pipeline-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init Main Pipeline
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(dev-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(pipeline-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsdevstorageterraform-key1)
                    TF_LOG: $(dev-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=dev.tfplan -var-file="dev.tfvars"
                  displayName: Terraform > Write Pipeline Plan
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve dev.tfplan
                  displayName: Terraform > Apply Main Pipeline
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                    
                # Set Durable Extension Code app setting, post Coordinator creation
                - bash: |
                    az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
                    az account set --subscription $ARM_SUBSCRIPTION_ID
                    durable_code=$(az functionapp keys list --resource-group rg-polaris-pipeline-dev --name fa-polaris-pipeline-dev-coordinator --query 'systemKeys.durabletask_extension' --output tsv)
                    az functionapp config appsettings set --name fa-polaris-pipeline-dev-coordinator --resource-group rg-polaris-pipeline-dev --settings "PolarisPipelineCoordinatorDurableExtensionCode=$durable_code"
                  displayName: Script > Set Durable Task Extension Code for Sliding Clear-Down
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Pipeline Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Coordinator - Started"
                    
                #download coordinator build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  displayName: Deploy > Download Coordinator Codebase Build
                  artifact: "polaris-coordinator-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  displayName: 'Deploy Coordinator Azure Function App to DEV'
                  inputs:
                    azureSubscription: $(dev-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-pipeline-dev-coordinator"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-coordinator-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Coordinator - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Pdf Generator - Started"
                
                #download pdf-generator build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  displayName: Deploy > Download PDF Generator Codebase Build
                  artifact: "polaris-pdf-generator-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  displayName: 'Deploy PDF Generator Azure Function App to DEV'
                  inputs:
                    azureSubscription: $(dev-azure-subscription)
                    appType: functionApp
                    appName: "fa-polaris-pipeline-dev-pdf-generator"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-pdf-generator-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Pdf Generator - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Text Extractor - Started"
                
                #download text-extractor build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  displayName: Deploy > Download Text Extractor Codebase Build
                  artifact: "polaris-text-extractor-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  displayName: 'Deploy Text Extractor Azure Function App to DEV'
                  inputs:
                    azureSubscription: $(dev-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-pipeline-dev-text-extractor"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-text-extractor-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Text Extractor - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Pipeline Events Terraform - Started"
                
                #download pipeline events terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  displayName: Terraform > Download Pipeline Events terraform build
                  artifact: "pipeline-events-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init Pipeline Events
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(dev-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(pipeline-events-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsdevstorageterraform-key1)
                    TF_LOG: $(dev-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=dev.tfplan -var-file="dev.tfvars"
                  displayName: Terraform > Write Pipeline Events Plan
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve dev.tfplan
                  displayName: Terraform > Apply Pipeline Events
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Pipeline Events Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: UI Terraform - Started"
                
                #download ui terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  displayName: Terraform > Download UI terraform build
                  artifact: "ui-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init UI Terraform
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(dev-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(ui-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsdevstorageterraform-key1)
                    TF_LOG: $(dev-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=dev.tfplan -var-file="dev.tfvars"
                  displayName: Terraform > Write UI Plan
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve dev.tfplan
                  displayName: Terraform > Apply UI Terraform
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: UI Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish SPA - Started"
                    
                #download UI build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: Deploy > Download SPA Codebase Build
                  artifact: "polaris-ui-drop"

                # Deploy Related Codebase to Env
                - task: AzureRmWebAppDeployment@4
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: 'Deploy SPA App Service to DEV'
                  inputs:
                    azureSubscription: $(dev-azure-subscription)
                    appType: webAppLinux
                    WebAppName: "as-web-polaris-dev"
                    packageForLinux: $(Pipeline.Workspace)/PolarisBuild/polaris-ui-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish SPA - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Gateway - Started"
                                
                #download gateway build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  displayName: Deploy > Download Gateway Codebase Build
                  artifact: "polaris-gateway-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  displayName: 'Deploy Gateway Azure Function App to DEV'
                  inputs:
                    azureSubscription: $(dev-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-dev-gateway"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-gateway-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Gateway - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Auth-Handover - Started"
                
                #download gateway build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  displayName: Deploy > Download Auth Handover Codebase Build
                  artifact: "polaris-auth-handover-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  displayName: 'Deploy Auth Handover Azure Function App to DEV'
                  inputs:
                    azureSubscription: $(dev-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-dev-auth-handover"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-auth-handover-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Publish Auth-Handover - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Set Log Analytics Archival Periods - Started"
                    
                # Set Log Analytics Archival Period - remove when supported natively by Terraform
                - bash: |
                    az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics-dev --workspace-name la-polaris-dev --name AppEvents --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics-dev --workspace-name la-polaris-dev --name AppRequests --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics-dev --workspace-name la-polaris-dev --name AppServiceConsoleLogs --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                  displayName: Script > Set Log Analytics Archival Periods
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    LOG_RETENTION_TIME: $(log-retention-time)
                    TOTAL_LOG_RETENTION_TIME: $(total-log-retention-time)
                    TF_LOG: $(dev-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Set Log Analytics Archival Periods - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Restarting SPA - Started"
                
                # Restart app service - moved away from deployment to buy some time    
                - task: AzureAppServiceManage@0
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: 'Restart SPA Azure App Service'
                  inputs:
                    azureSubscription: $(dev-azure-subscription)
                    Action: 'Restart Azure App Service'
                    WebAppName: "as-web-polaris-dev"
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Restarting SPA - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: UI Events Terraform - Started"
                    
                #download ui events terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  displayName: Terraform > Download UI Events terraform build
                  artifact: "ui-events-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init UI Events
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(dev-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(ui-events-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsdevstorageterraform-key1)
                    TF_LOG: $(dev-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=dev.tfplan -var-file="dev.tfvars"
                  displayName: Terraform > Write UI Events Plan
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve dev.tfplan
                  displayName: Terraform > Apply UI Events
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-development-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-development-spn-secret)
                    ARM_TENANT_ID: $(innovation-development-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-development-subscription-id)
                    TF_LOG: $(dev-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: UI Events Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: succeeded()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Completed"
                      
                #send any errors to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Record Errors'
                  condition: failed()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                      -PatToken: "$(devops-pat-token)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -ReleaseId "$(Build.BuildId)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "DEV Deployment: Failed"
                    
  - stage: Check_DEV
    displayName: Status Checks > DEV
    dependsOn:
      - Determine_Changes
      - Apply_DEV
    condition: succeeded()
    variables:
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_DEV']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_DEV']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_DEV']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_DEV']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_DEV']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_DEV']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_DEV']]
    pool:
      vmImage: ubuntu-latest
    jobs:
      - job: Run_Status_Checks
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'
            
          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(dev_pre-shared_key)
              PRIVATEKEY: $(dev_private_key)
              CLIENTCERTIFICATE: $(dev_client_cert)
              VPNSERVER: $(dev_vpn_server)
              DNSSERVER: $(dev_dns_server)
            displayName: Creating DEV VPN tunnel
            
          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()
            
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Status Checks - Started"

          #query coordinator status endpoint
          - task: PowerShell@2
            displayName: 'Checking DEV Coordinator status'
            condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(dev-coordinator-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query pdf-generator status endpoint
          - task: PowerShell@2
            displayName: 'Checking DEV PDF-Generator status'
            condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(dev-pdf-generator-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query text-extractor status endpoint
          - task: PowerShell@2
            displayName: 'Checking DEV Text-Extractor status'
            condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(dev-text-extractor-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query auth-handover status endpoint
          - task: PowerShell@2
            displayName: 'Checking DEV Auth-Handover status'
            condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(dev-auth-handover-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query gateway status endpoint
          - task: PowerShell@2
            displayName: 'Checking DEV Gateway status'
            condition: and(succeeded(), eq(variables.runGateway, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(dev-gateway-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query proxy status endpoint
          - task: PowerShell@2
            displayName: 'Checking DEV Proxy status'
            condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetryNonNumeric.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(dev-proxy-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "Polaris Proxy is online"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)
                
          #query proxy status endpoint
          - task: PowerShell@2
            displayName: 'Checking DEV UI status'
            condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(dev-ui-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)
                
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Status Checks - Completed"
                
          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Status Checks - Failed"
                
  - stage: Create_DEV_Report
    displayName: Create Report > DEV
    dependsOn: Check_DEV
    jobs:
      - job: Create_DEV_Report
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'
            
          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(dev_pre-shared_key)
              PRIVATEKEY: $(dev_private_key)
              CLIENTCERTIFICATE: $(dev_client_cert)
              VPNSERVER: $(dev_vpn_server)
              DNSSERVER: $(dev_dns_server)
            displayName: Creating DEV VPN tunnel
            
          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Create Report - Started"
            
          - checkout: self
            persistCredentials: true

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                git log dev...HEAD --oneline --pretty=format:%h,%an,%ae,%s > commit-report-dev.csv
            displayName: Generate commit report for DEV

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.Repository.LocalPath)/commit-report-dev.csv"
              artifact: "Commit Report - DEV ($(System.JobAttempt))"
            displayName: "Publish Commit report for DEV"
            
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Create Report - Completed"
                
          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Create Report - Failed"

  - stage: Update_DEV_Tag
    displayName: Update Tag > DEV
    dependsOn: Create_DEV_Report
    condition: succeeded()
    jobs:
      - job: Update_DEV_Tag
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files' 
          
          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(dev_pre-shared_key)
              PRIVATEKEY: $(dev_private_key)
              CLIENTCERTIFICATE: $(dev_client_cert)
              VPNSERVER: $(dev_vpn_server)
              DNSSERVER: $(dev_dns_server)
            displayName: Creating DEV VPN tunnel

          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Update Tag - Started"
                
          - checkout: self
            persistCredentials: true

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                git config user.name "$BUILD_REQUESTEDFOR"
                git config user.email "$BUILD_REQUESTEDFOREMAIL"
                
                git push origin :refs/tags/dev
                git tag -f dev
                git push origin dev
            displayName: Updating the dev tag
            
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Update Tag - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Update Tag - Failed"
                    
  - stage: Run_e2e_Tests_DEV
    displayName: Run e2e tests > DEV
    dependsOn: 
      - Determine_Changes
      - Apply_DEV
      - Check_DEV
      - Update_DEV_Tag
    condition: succeeded()
    variables:
      runPipelineTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TERRAFORM_DEV']]
      runPipelineEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_EVENTS_TERRAFORM_DEV']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_DEV']]
      runUIEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_EVENTS_TERRAFORM_DEV']]
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_DEV']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_DEV']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_DEV']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_DEV']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_DEV']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_DEV']]
      runE2ETests: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_E2E_TESTS_DEV']]
    jobs:
      - job: Run_e2e_Tests_DEV
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'
            
          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(dev_pre-shared_key)
              PRIVATEKEY: $(dev_private_key)
              CLIENTCERTIFICATE: $(dev_client_cert)
              VPNSERVER: $(dev_vpn_server)
              DNSSERVER: $(dev_dns_server)
            displayName: Creating DEV VPN tunnel

          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Run e2e Tests - Started"
                
          - task: benjhuser.tfs-extensions-build-tasks.trigger-build-task.TriggerBuild@4
            displayName: 'Run the e2e tests: DEV'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              buildDefinition: 129
              waitForQueuedBuildsToFinish: true
              cancelBuildsIfAnyFails: true
              password: $(devops-pat-token)
              
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Run e2e Tests - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-development-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "DEV Deployment: Run e2e Tests - Failed"

  - stage: Apply_QA
    displayName: Deployment > QA
    dependsOn:
      - Determine_Changes
      - Update_DEV_Tag
      - Run_e2e_Tests_DEV
    condition: succeeded()
    variables:
      runPipelineTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TERRAFORM_QA']]
      runPipelineEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_EVENTS_TERRAFORM_QA']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_QA']]
      runUIEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_EVENTS_TERRAFORM_QA']]
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_QA']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_QA']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_QA']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_QA']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_QA']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_QA']]
    pool:
      vmImage: ubuntu-latest
    jobs:
      - deployment: CI_Deploy_Polaris
        environment: "QA"
        strategy:
          runOnce:
            deploy:
              steps:
                #download templates artifact
                - download: PolarisBuild
                  displayName: Download Templates
                  artifact: 'polaris-template-files'
                  
                #download scripts artifact
                - download: PolarisBuild
                  displayName: Download Scripts
                  artifact: 'polaris-script-files'

                #create vpn tunnel
                - bash: |
                    sudo apt-get --assume-yes --no-install-recommends install openvpn

                    chmod 777 vpnconfig.ovpn
                    envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

                    sudo openvpn _vpnconfig.ovpn &

                    sleep 5

                    ifconfig tun0

                    sudo rm /etc/resolv.conf
                    echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
                  env:
                    PRESHAREDKEY: $(qa_pre-shared_key)
                    PRIVATEKEY: $(qa_private_key)
                    CLIENTCERTIFICATE: $(qa_client_cert)
                    VPNSERVER: $(qa_vpn_server)
                    DNSSERVER: $(qa_dns_server)
                  displayName: Creating QA VPN tunnel
                  
                # Install Terraform based on version variable
                - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
                  displayName: Terraform > Install
                  condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true')))
                  inputs:
                    terraformVersion: $(terraform-version)
                    
                #install nuget
                - bash: |
                    sudo yum install -y mono-complete
                    sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
                    sudo chmod +x /usr/local/bin/nuget
                    nuget install Microsoft.ApplicationInsights
                  displayName: Installing Application Insights
                  condition: succeeded()

                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: succeeded()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Started"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Pipeline Terraform - Started"
                
                #download pipeline terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  displayName: Terraform > Download Pipeline terraform build
                  artifact: "pipeline-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(qa-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(pipeline-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsqastorageterraform-key1)
                    TF_LOG: $(qa-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=qa.tfplan -var-file="qa.tfvars"
                  displayName: 'Terraform > Write Pipeline Plan'
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve qa.tfplan
                  displayName: Terraform > Apply to QA
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                    
                # Set Durable Extension Code app setting, post Coordinator creation
                - bash: |
                    az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
                    az account set --subscription $ARM_SUBSCRIPTION_ID
                    durable_code=$(az functionapp keys list --resource-group rg-polaris-pipeline-qa --name fa-polaris-pipeline-qa-coordinator --query 'systemKeys.durabletask_extension' --output tsv)
                    az functionapp config appsettings set --name fa-polaris-pipeline-qa-coordinator --resource-group rg-polaris-pipeline-qa --settings "PolarisPipelineCoordinatorDurableExtensionCode=$durable_code"
                  displayName: Script > Set Durable Task Extension Code for Sliding Clear-Down
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Pipeline Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish Coordinator - Started"
                    
                #download coordinator build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  displayName: Deploy > Download Coordinator Codebase Build
                  artifact: "polaris-coordinator-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  displayName: 'Deploy Coordinator Azure Function App to QA'
                  inputs:
                    azureSubscription: $(qa-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-pipeline-qa-coordinator"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-coordinator-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish Coordinator - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish PDF Generator - Started"
                
                #download pdf-generator build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  displayName: Deploy > Download PDF Generator Codebase Build
                  artifact: "polaris-pdf-generator-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  displayName: 'Deploy PDF Generator Azure Function App to QA'
                  inputs:
                    azureSubscription: $(qa-azure-subscription)
                    appType: functionApp
                    appName: "fa-polaris-pipeline-qa-pdf-generator"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-pdf-generator-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish PDF Generator - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish Text Extractor - Started"
                
                #download text-extractor build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  displayName: Deploy > Download Text Extractor Codebase Build
                  artifact: "polaris-text-extractor-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  displayName: 'Deploy Text Extractor Azure Function App to QA'
                  inputs:
                    azureSubscription: $(qa-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-pipeline-qa-text-extractor"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-text-extractor-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish Text Extractor - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Pipeline Events Terraform - Started"
                
                #download pipeline events terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  displayName: Terraform > Download Pipeline Events terraform build
                  artifact: "pipeline-events-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(qa-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(pipeline-events-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsqastorageterraform-key1)
                    TF_LOG: $(qa-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=qa.tfplan -var-file="qa.tfvars"
                  displayName: 'Terraform > Write Pipeline Events Plan'
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve qa.tfplan
                  displayName: Terraform > Apply to QA
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Pipeline Events Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: UI Terraform - Started"
                
                #download ui terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  displayName: Terraform > Download UI terraform build
                  artifact: "ui-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(qa-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(ui-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsqastorageterraform-key1)
                    TF_LOG: $(qa-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=qa.tfplan -var-file="qa.tfvars"
                  displayName: 'Terraform > Write UI Plan'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve qa.tfplan
                  displayName: Terraform > Apply to QA
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: UI Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish SPA - Started"
                    
                #download UI build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: Deploy > Download SPA Codebase Build
                  artifact: "polaris-ui-drop"

                # Deploy Related Codebase to Env
                - task: AzureRmWebAppDeployment@4
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: 'Deploy UI App Service to QA'
                  inputs:
                    azureSubscription: $(qa-azure-subscription)
                    appType: webAppLinux
                    WebAppName: "as-web-polaris-qa"
                    packageForLinux: $(Pipeline.Workspace)/PolarisBuild/polaris-ui-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish SPA - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish Gateway - Started"
                
                #download gateway build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  displayName: Deploy > Download Gateway Codebase Build
                  artifact: "polaris-gateway-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  displayName: 'Deploy Gateway Azure Function App to QA'
                  inputs:
                    azureSubscription: $(qa-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-qa-gateway"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-gateway-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish Gateway - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish Auth Handover - Started"
                
                #download gateway build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  displayName: Deploy > Download Auth Handover Codebase Build
                  artifact: "polaris-auth-handover-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  displayName: 'Deploy Auth Handover Azure Function App to QA'
                  inputs:
                    azureSubscription: $(qa-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-qa-auth-handover"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-auth-handover-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Publish Auth Handover - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Set Log Analytics Archival Period - Started"
                    
                # Set Log Analytics Archival Period - remove when supported natively by Terraform
                - bash: |
                    az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics-qa --workspace-name la-polaris-qa --name AppEvents --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics-qa --workspace-name la-polaris-qa --name AppRequests --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics-qa --workspace-name la-polaris-qa --name AppServiceConsoleLogs --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  displayName: Script > Set Log Analytics Archival Periods
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    LOG_RETENTION_TIME: $(log-retention-time)
                    TOTAL_LOG_RETENTION_TIME: $(total-log-retention-time)
                    TF_LOG: $(qa-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Set Log Analytics Archival Period - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Restart SPA - Started"
                
                # Restart app service    
                - task: AzureAppServiceManage@0
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: 'Restart Azure App Service'
                  inputs:
                    azureSubscription: $(qa-azure-subscription)
                    Action: 'Restart Azure App Service'
                    WebAppName: "as-web-polaris-qa"
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Restart SPA - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: UI Events Terraform - Started"
                        
                #download ui events terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  displayName: Terraform > Download UI Events terraform build
                  artifact: "ui-events-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(qa-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(ui-events-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsqastorageterraform-key1)
                    TF_LOG: $(qa-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=qa.tfplan -var-file="qa.tfvars"
                  displayName: 'Terraform > Write UI Events Plan'
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve qa.tfplan
                  displayName: Terraform > Apply to QA
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-qa-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-qa-spn-secret)
                    ARM_TENANT_ID: $(innovation-qa-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-qa-subscription-id)
                    TF_LOG: $(qa-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: UI Events Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: succeeded()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Completed"
                      
                #send any errors to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Record Errors'
                  condition: failed()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                      -PatToken: "$(devops-pat-token)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -ReleaseId "$(Build.BuildId)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "QA Deployment: Failed"
                    
  - stage: Check_QA
    displayName: Status Checks > QA
    dependsOn:
      - Determine_Changes
      - Apply_QA
    condition: succeeded()
    variables:
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_QA']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_QA']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_QA']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_QA']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_QA']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_QA']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_QA']]
    pool:
      vmImage: ubuntu-latest
    jobs:
      - job: Run_Status_Checks
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'
            
          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(qa_pre-shared_key)
              PRIVATEKEY: $(qa_private_key)
              CLIENTCERTIFICATE: $(qa_client_cert)
              VPNSERVER: $(qa_vpn_server)
              DNSSERVER: $(qa_dns_server)
            displayName: Creating QA VPN tunnel
          
          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Status Checks - Started"  
          
          #query coordinator status endpoint
          - task: PowerShell@2
            displayName: 'Checking QA Coordinator status'
            condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(qa-coordinator-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query pdf-generator status endpoint
          - task: PowerShell@2
            displayName: 'Checking QA PDF-Generator status'
            condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(qa-pdf-generator-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query text-extractor status endpoint
          - task: PowerShell@2
            displayName: 'Checking QA Text-Extractor status'
            condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(qa-text-extractor-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query auth-handover status endpoint
          - task: PowerShell@2
            displayName: 'Checking QA Auth-Handover status'
            condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(qa-auth-handover-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query gateway status endpoint
          - task: PowerShell@2
            displayName: 'Checking QA Gateway status'
            condition: and(succeeded(), eq(variables.runGateway, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(qa-gateway-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query proxy status endpoint
          - task: PowerShell@2
            displayName: 'Checking QA Proxy status'
            condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetryNonNumeric.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(qa-proxy-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "Polaris Proxy is online"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)
          
          #query proxy status endpoint
          - task: PowerShell@2
            displayName: 'Checking QA UI status'
            condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(qa-ui-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)
                
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Status Checks - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Status Checks - Failed"
                
  - stage: Create_QA_Report
    displayName: Create Report > QA
    dependsOn: Check_QA
    jobs:
      - job: Create_QA_Report
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'

          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(qa_pre-shared_key)
              PRIVATEKEY: $(qa_private_key)
              CLIENTCERTIFICATE: $(qa_client_cert)
              VPNSERVER: $(qa_vpn_server)
              DNSSERVER: $(qa_dns_server)
            displayName: Creating QA VPN tunnel

          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Create Report - Started"
                
          - checkout: self
            persistCredentials: true

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                git log qa...HEAD --oneline --pretty=format:%h,%an,%ae,%s > commit-report-qa.csv
            displayName: Generate commit report for QA

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.Repository.LocalPath)/commit-report-qa.csv"
              artifact: "Commit Report - QA ($(System.JobAttempt))"
            displayName: "Publish Commit report for QA"
            
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Create Report - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Create Report - Failed"
                
  - stage: Update_QA_Tag
    displayName: Update Tag > QA
    dependsOn: Create_QA_Report
    condition: succeeded()
    jobs:
      - job: Update_QA_Tag
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'

          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(qa_pre-shared_key)
              PRIVATEKEY: $(qa_private_key)
              CLIENTCERTIFICATE: $(qa_client_cert)
              VPNSERVER: $(qa_vpn_server)
              DNSSERVER: $(qa_dns_server)
            displayName: Creating QA VPN tunnel

          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Update Tag - Started"
                
          - checkout: self
            persistCredentials: true

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                git config user.name "$BUILD_REQUESTEDFOR"
                git config user.email "$BUILD_REQUESTEDFOREMAIL"
                
                git push origin :refs/tags/qa
                git tag -f qa
                git push origin qa 
            displayName: Updating the qa tag
            
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Update Tag - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Update Tag - Failed"
            
  - stage: Run_e2e_Tests_QA
    displayName: Run e2e tests > QA
    dependsOn:
      - Determine_Changes
      - Apply_QA
      - Check_QA
      - Update_QA_Tag
    condition: succeeded()
    variables:
      runPipelineTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TERRAFORM_QA']]
      runPipelineEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_EVENTS_TERRAFORM_QA']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_QA']]
      runUIEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_EVENTS_TERRAFORM_QA']]
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_QA']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_QA']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_QA']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_QA']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_QA']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_QA']]
      runE2ETests: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_E2E_TESTS_QA']]
    jobs:
      - job: Run_e2e_Tests_QA
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'

          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(qa_pre-shared_key)
              PRIVATEKEY: $(qa_private_key)
              CLIENTCERTIFICATE: $(qa_client_cert)
              VPNSERVER: $(qa_vpn_server)
              DNSSERVER: $(qa_dns_server)
            displayName: Creating QA VPN tunnel

          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Run e2e Tests - Started"
                
          - task: benjhuser.tfs-extensions-build-tasks.trigger-build-task.TriggerBuild@4
            displayName: 'Run the e2e tests: QA'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              buildDefinition: 210
              waitForQueuedBuildsToFinish: true
              cancelBuildsIfAnyFails: true
              password: $(devops-pat-token)
              
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Run e2e Tests - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-qa-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "QA Deployment: Run e2e Tests - Failed"

  - stage: Apply_PROD
    displayName: Deployment > PROD
    dependsOn:
      - Determine_Changes
      - Update_DEV_Tag
      - Run_e2e_Tests_DEV
    condition: succeeded()
    variables:
      runPipelineTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TERRAFORM_PROD']]
      runPipelineEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_EVENTS_TERRAFORM_PROD']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_PROD']]
      runUIEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_EVENTS_TERRAFORM_PROD']]
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_PROD']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_PROD']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_PROD']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_PROD']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_PROD']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_PROD']]
    pool:
      vmImage: ubuntu-latest
    jobs:
      - deployment: CI_Deploy_Polaris
        environment: "Prod"
        strategy:
          runOnce:
            deploy:
              steps:
                #download templates artifact
                - download: PolarisBuild
                  displayName: Download Templates
                  artifact: 'polaris-template-files'
                  
                #download scripts artifact
                - download: PolarisBuild
                  displayName: Download Scripts
                  artifact: 'polaris-script-files'

                #create vpn tunnel
                - bash: |
                    sudo apt-get --assume-yes --no-install-recommends install openvpn

                    chmod 777 vpnconfig.ovpn
                    envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

                    sudo openvpn _vpnconfig.ovpn &

                    sleep 5

                    ifconfig tun0

                    sudo rm /etc/resolv.conf
                    echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
                  env:
                    PRESHAREDKEY: $(prod_pre-shared_key)
                    PRIVATEKEY: $(prod_private_key)
                    CLIENTCERTIFICATE: $(prod_client_cert)
                    VPNSERVER: $(prod_vpn_server)
                    DNSSERVER: $(prod_dns_server)
                  displayName: Creating PROD VPN tunnel
                  
                # Install Terraform based on version variable
                - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
                  displayName: Terraform > Install
                  condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true')))
                  inputs:
                    terraformVersion: $(terraform-version)
                    
                #install nuget
                - bash: |
                    sudo yum install -y mono-complete
                    sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
                    sudo chmod +x /usr/local/bin/nuget
                    nuget install Microsoft.ApplicationInsights
                  displayName: Installing Application Insights
                  condition: succeeded()

                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: succeeded()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Started"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Pipeline Terraform - Started"
                
                #download pipeline terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  displayName: Terraform > Download Pipeline terraform build
                  artifact: "pipeline-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(prod-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(pipeline-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsprodstorageterraform-key1)
                    TF_LOG: $(prod-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=prod.tfplan -var-file="prod.tfvars"
                  displayName: 'Terraform > Write Pipeline Plan'
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve prod.tfplan
                  displayName: Terraform > Apply to PROD
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                    
                # Set Durable Extension Code app setting, post Coordinator creation
                - bash: |
                    az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
                    az account set --subscription $ARM_SUBSCRIPTION_ID
                    durable_code=$(az functionapp keys list --resource-group rg-polaris-pipeline --name fa-polaris-pipeline-coordinator --query 'systemKeys.durabletask_extension' --output tsv)
                    az functionapp config appsettings set --name fa-polaris-pipeline-coordinator --resource-group rg-polaris-pipeline --settings "PolarisPipelineCoordinatorDurableExtensionCode=$durable_code"
                  displayName: Script > Set Durable Task Extension Code for Sliding Clear-Down
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-terraform-files
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Pipeline Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish Coordinator - Started"
                    
                #download coordinator build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  displayName: Deploy > Download Coordinator Codebase Build
                  artifact: "polaris-coordinator-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  displayName: 'Deploy Coordinator Azure Function App to PROD'
                  inputs:
                    azureSubscription: $(prod-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-pipeline-coordinator"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-coordinator-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish Coordinator - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish PDF Generator - Started"
                
                #download pdf-generator build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  displayName: Deploy > Download PDF Generator Codebase Build
                  artifact: "polaris-pdf-generator-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  displayName: 'Deploy PDF Generator Azure Function App to PROD'
                  inputs:
                    azureSubscription: $(prod-azure-subscription)
                    appType: functionApp
                    appName: "fa-polaris-pipeline-pdf-generator"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-pdf-generator-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish PDF Generator - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish Text Extractor - Started"
                
                #download text-extractor build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  displayName: Deploy > Download Text Extractor Codebase Build
                  artifact: "polaris-text-extractor-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  displayName: 'Deploy Text Extractor Azure Function App to PROD'
                  inputs:
                    azureSubscription: $(prod-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-pipeline-text-extractor"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-text-extractor-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish Text Extractor - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Pipeline Events Terraform - Started"
                
                #download pipeline events terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  displayName: Terraform > Download Pipeline Events terraform build
                  artifact: "pipeline-events-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(prod-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(pipeline-events-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsprodstorageterraform-key1)
                    TF_LOG: $(prod-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=prod.tfplan -var-file="prod.tfvars"
                  displayName: 'Terraform > Write Pipeline Events Plan'
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve prod.tfplan
                  displayName: Terraform > Apply to PROD
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/pipeline-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runPipelineEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Pipeline Events Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: UI Terraform - Started"
                
                #download ui terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  displayName: Terraform > Download UI terraform build
                  artifact: "ui-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(prod-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(ui-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsprodstorageterraform-key1)
                    TF_LOG: $(prod-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=prod.tfplan -var-file="prod.tfvars"
                  displayName: 'Terraform > Write UI Plan'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve prod.tfplan
                  displayName: Terraform > Apply to PROD
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: UI Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish SPA - Started"
                    
                #download UI build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: Deploy > Download SPA Codebase Build
                  artifact: "polaris-ui-drop"

                # Deploy Related Codebase to Env
                - task: AzureRmWebAppDeployment@4
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: 'Deploy UI App Service to PROD'
                  inputs:
                    azureSubscription: $(prod-azure-subscription)
                    appType: webAppLinux
                    WebAppName: "as-web-polaris"
                    packageForLinux: $(Pipeline.Workspace)/PolarisBuild/polaris-ui-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish SPA - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish Gateway - Started"
                
                #download gateway build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  displayName: Deploy > Download Gateway Codebase Build
                  artifact: "polaris-gateway-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  displayName: 'Deploy Gateway Azure Function App to PROD'
                  inputs:
                    azureSubscription: $(prod-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-gateway"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-gateway-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runGateway, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish Gateway - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish Auth Handover - Started"
                
                #download gateway build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  displayName: Deploy > Download Auth Handover Codebase Build
                  artifact: "polaris-auth-handover-drop"
                
                # Deploy Related Codebase to Env
                - task: AzureFunctionApp@1
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  displayName: 'Deploy Auth Handover Azure Function App to PROD'
                  inputs:
                    azureSubscription: $(prod-azure-subscription)
                    appType: functionAppLinux
                    appName: "fa-polaris-auth-handover"
                    package: $(Pipeline.Workspace)/PolarisBuild/polaris-auth-handover-drop
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Publish Auth Handover - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Set Log Analytics Archival Period - Started"
                    
                # Set Log Analytics Archival Period - remove when supported natively by Terraform
                - bash: |
                    az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics --workspace-name la-polaris --name AppEvents --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics --workspace-name la-polaris --name AppRequests --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                    az monitor log-analytics workspace table update --resource-group rg-polaris-analytics --workspace-name la-polaris --name AppServiceConsoleLogs --retention-time $LOG_RETENTION_TIME --total-retention-time $TOTAL_LOG_RETENTION_TIME --subscription $ARM_SUBSCRIPTION_ID
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  displayName: Script > Set Log Analytics Archival Periods
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    LOG_RETENTION_TIME: $(log-retention-time)
                    TOTAL_LOG_RETENTION_TIME: $(total-log-retention-time)
                    TF_LOG: $(prod-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Set Log Analytics Archival Period - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Restart SPA - Started"
                
                # Restart app service    
                - task: AzureAppServiceManage@0
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  displayName: 'Restart Azure App Service'
                  inputs:
                    azureSubscription: $(prod-azure-subscription)
                    Action: 'Restart Azure App Service'
                    WebAppName: "as-web-polaris"
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Restart SPA - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: UI Events Terraform - Started"
                    
                #download ui events terraform build artifact
                - download: PolarisBuild
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  displayName: Terraform > Download UI Events terraform build
                  artifact: "ui-events-terraform-files"
                
                # Terraform Init
                - bash: |
                    terraform init \
                      -backend-config="storage_account_name=$TF_STATE_ACCOUNT_NAME" \
                      -backend-config="container_name=$TF_STATE_CONTAINER_NAME" \
                      -backend-config="key=$TF_STATE_KEY" \
                      -backend-config="access_key=$TF_STATE_ACCESS_KEY"
                  displayName: Terraform > Init
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    TF_STATE_ACCOUNT_NAME: $(prod-terraform-storage-account)
                    TF_STATE_CONTAINER_NAME: $(ui-events-terraform-container-name)
                    TF_STATE_KEY: $(terraform-key)
                    TF_STATE_ACCESS_KEY: $(cpsprodstorageterraform-key1)
                    TF_LOG: $(prod-log-level)
                
                # Terraform Plan
                - bash: |
                    terraform plan -input=false -out=prod.tfplan -var-file="prod.tfvars"
                  displayName: 'Terraform > Write UI Events Plan'
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                
                # Terraform Apply
                - bash: |
                    terraform apply -auto-approve prod.tfplan
                  displayName: Terraform > Apply to PROD
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  workingDirectory: $(Pipeline.Workspace)/PolarisBuild/ui-events-terraform-files
                  env:
                    ARM_CLIENT_ID: $(innovation-prod-spn-client-id)
                    ARM_CLIENT_SECRET: $(innovation-prod-spn-secret)
                    ARM_TENANT_ID: $(innovation-prod-spn-tenant-id)
                    ARM_SUBSCRIPTION_ID: $(innovation-prod-subscription-id)
                    TF_LOG: $(prod-log-level)
                    
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: and(succeeded(), eq(variables.runUIEventsTerraform, 'true'))
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: UI Events Terraform - Completed"
                      
                #send custom event to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Trace'
                  condition: succeeded()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Completed"

                #send any errors to AppInsights
                - task: PowerShell@2
                  displayName: 'AppInsights: Record Errors'
                  condition: failed()
                  inputs:
                    failOnStderr: true
                    targetType: 'filePath'
                    filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
                    arguments: > # Use this to avoid newline characters in multi-line string
                      -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                      -PatToken: "$(devops-pat-token)"
                      -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                      -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                      -ReleaseId "$(Build.BuildId)"
                      -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                      -Message "PROD Deployment: Failed"
                    
  - stage: Check_PROD
    displayName: Status Checks > PROD
    dependsOn:
      - Determine_Changes
      - Apply_PROD
    condition: succeeded()
    variables:
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_PROD']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_PROD']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_PROD']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_PROD']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_PROD']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_PROD']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_PROD']]
    pool:
      vmImage: ubuntu-latest
    jobs:
      - job: Run_Status_Checks
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'
            
          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(prod_pre-shared_key)
              PRIVATEKEY: $(prod_private_key)
              CLIENTCERTIFICATE: $(prod_client_cert)
              VPNSERVER: $(prod_vpn_server)
              DNSSERVER: $(prod_dns_server)
            displayName: Creating PROD VPN tunnel
            
          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Status Checks - Started"
            
          #query coordinator status endpoint
          - task: PowerShell@2
            displayName: 'Checking PROD Coordinator status'
            condition: and(succeeded(), eq(variables.runCoordinator, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(prod-coordinator-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query pdf-generator status endpoint
          - task: PowerShell@2
            displayName: 'Checking PROD PDF-Generator status'
            condition: and(succeeded(), eq(variables.runPdfGenerator, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(prod-pdf-generator-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query text-extractor status endpoint
          - task: PowerShell@2
            displayName: 'Checking PROD Text-Extractor status'
            condition: and(succeeded(), eq(variables.runTextExtractor, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(prod-text-extractor-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query auth-handover status endpoint
          - task: PowerShell@2
            displayName: 'Checking PROD Auth-Handover status'
            condition: and(succeeded(), eq(variables.runAuthHandover, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(prod-auth-handover-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query gateway status endpoint
          - task: PowerShell@2
            displayName: 'Checking PROD Gateway status'
            condition: and(succeeded(), eq(variables.runGateway, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(prod-gateway-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)

          #query proxy status endpoint
          - task: PowerShell@2
            displayName: 'Checking PROD Proxy status'
            condition: and(succeeded(), eq(variables.runUITerraform, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetryNonNumeric.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(prod-proxy-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "Polaris Proxy is online"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)
          
          #query proxy status endpoint
          - task: PowerShell@2
            displayName: 'Checking PROD UI status'
            condition: and(succeeded(), eq(variables.runUICodebase, 'true'))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/InvokeRequestWithRetry.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -URI $(prod-ui-status-url)
                -Method $(status-check-method)
                -SuccessTextContent "$(resources.pipeline.PolarisBuild.runName)"
                -Retries $(status-check-retries)
                -SecondsDelay $(status-check-delay-seconds)
                -TimeoutSec $(status-check-timeout-seconds)
                
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Status Checks - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Status Checks - Failed"
                
  - stage: Create_PROD_Report
    displayName: Create Report > PROD
    dependsOn: Check_PROD
    jobs:
      - job: Create_PROD_Report
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'

          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(prod_pre-shared_key)
              PRIVATEKEY: $(prod_private_key)
              CLIENTCERTIFICATE: $(prod_client_cert)
              VPNSERVER: $(prod_vpn_server)
              DNSSERVER: $(prod_dns_server)
            displayName: Creating PROD VPN tunnel

          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Create Report - Started"
                
          - checkout: self
            persistCredentials: true

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                git log prod...HEAD --oneline --pretty=format:%h,%an,%ae,%s > commit-report-prod.csv
            displayName: Generate commit report for PROD

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.Repository.LocalPath)/commit-report-prod.csv"
              artifact: "Commit Report - PROD ($(System.JobAttempt))"
            displayName: "Publish Commit report for PROD"
            
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Create Report - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Create Report - Failed"
                
  - stage: Update_PROD_Tag
    displayName: Update Tag > PROD
    dependsOn: Create_PROD_Report
    condition: succeeded()
    jobs:
      - job: Update_PROD_Tag
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'

          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(prod_pre-shared_key)
              PRIVATEKEY: $(prod_private_key)
              CLIENTCERTIFICATE: $(prod_client_cert)
              VPNSERVER: $(prod_vpn_server)
              DNSSERVER: $(prod_dns_server)
            displayName: Creating PROD VPN tunnel

          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Update Tag - Started"
                
          - checkout: self
            persistCredentials: true

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                git config user.name "$BUILD_REQUESTEDFOR"
                git config user.email "$BUILD_REQUESTEDFOREMAIL"
                
                git push origin :refs/tags/prod
                git tag -f prod
                git push origin prod 
            displayName: Updating the prod tag
            
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: succeeded()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Update Tag - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Update Tag - Failed"
            
  - stage: Run_e2e_Tests_PROD
    displayName: Run e2e tests > PROD
    dependsOn:
      - Determine_Changes
      - Apply_PROD
      - Check_PROD
      - Update_PROD_Tag
    condition: succeeded()
    variables:
      runPipelineTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TERRAFORM_PROD']]
      runPipelineEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_EVENTS_TERRAFORM_PROD']]
      runUITerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_TERRAFORM_PROD']]
      runUIEventsTerraform: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_EVENTS_TERRAFORM_PROD']]
      runCoordinator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_COORDINATOR_PROD']]
      runPdfGenerator: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_PDF_GENERATOR_PROD']]
      runTextExtractor: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_PIPELINE_TEXT_EXTRACTOR_PROD']]
      runGateway: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_GATEWAY_PROD']]
      runAuthHandover: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_GATEWAY_AUTH_HANDOVER_PROD']]
      runUICodebase: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_UI_CODEBASE_PROD']]
      runE2ETests: $[stageDependencies.Determine_Changes.Generate_Diff.outputs['Change_Results.RUN_E2E_TESTS_PROD']]
    jobs:
      - job: Run_e2e_Tests_PROD
        pool:
          vmImage: ubuntu-latest
        steps:
          #download templates artifact
          - download: PolarisBuild
            displayName: Download Templates
            artifact: 'polaris-template-files'

          #download scripts artifact
          - download: PolarisBuild
            displayName: Download Scripts
            artifact: 'polaris-script-files'

          #create vpn tunnel
          - bash: |
              sudo apt-get --assume-yes --no-install-recommends install openvpn

              chmod 777 vpnconfig.ovpn
              envsubst < vpnconfig.ovpn > _vpnconfig.ovpn

              sudo openvpn _vpnconfig.ovpn &

              sleep 5

              ifconfig tun0

              sudo rm /etc/resolv.conf
              echo "nameserver $DNSSERVER" | sudo tee /etc/resolv.conf
            workingDirectory: $(Pipeline.Workspace)/PolarisBuild/polaris-template-files
            env:
              PRESHAREDKEY: $(prod_pre-shared_key)
              PRIVATEKEY: $(prod_private_key)
              CLIENTCERTIFICATE: $(prod_client_cert)
              VPNSERVER: $(prod_vpn_server)
              DNSSERVER: $(prod_dns_server)
            displayName: Creating PROD VPN tunnel

          #install nuget
          - bash: |
              sudo yum install -y mono-complete
              sudo wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O /usr/local/bin/nuget
              sudo chmod +x /usr/local/bin/nuget
              nuget install Microsoft.ApplicationInsights
            displayName: Installing Application Insights
            condition: succeeded()

          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Run e2e Tests - Started"
                
          - task: benjhuser.tfs-extensions-build-tasks.trigger-build-task.TriggerBuild@4
            displayName: 'Run the e2e tests: PROD'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              buildDefinition: 240
              waitForQueuedBuildsToFinish: true
              cancelBuildsIfAnyFails: true
              password: $(devops-pat-token)
              
          #send custom event to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Trace'
            condition: and(succeeded(), or(eq(variables.runPipelineTerraform, 'true'),eq(variables.runPipelineEventsTerraform, 'true'),eq(variables.runUITerraform, 'true'),eq(variables.runUIEventsTerraform, 'true'),eq(variables.runCoordinator, 'true'),eq(variables.runPdfGenerator, 'true'),eq(variables.runTextExtractor, 'true'),eq(variables.runGateway, 'true'),eq(variables.runAuthHandover, 'true'),eq(variables.runUICodebase, 'true'),eq(variables.runE2ETests, 'true')))
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Run e2e Tests - Completed"

          #send any errors to AppInsights
          - task: PowerShell@2
            displayName: 'AppInsights: Record Errors'
            condition: failed()
            inputs:
              failOnStderr: true
              targetType: 'filePath'
              filePath: $(Pipeline.Workspace)/PolarisBuild/polaris-script-files/SendCustomErrorEventToAppInsights.ps1
              arguments: > # Use this to avoid newline characters in multi-line string
                -InstrumentationKey "$(innovation-prod-app-insights-instrumentation-key)"
                -PatToken: "$(devops-pat-token)"
                -PipelineName "$(resources.pipeline.PolarisBuild.pipelineName)"
                -CommitId "$(resources.pipeline.PolarisBuild.sourceCommit)"
                -ReleaseId "$(Build.BuildId)"
                -BuildName "$(resources.pipeline.PolarisBuild.runName)"
                -Message "PROD Deployment: Run e2e Tests - Failed"